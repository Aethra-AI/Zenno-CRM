# ‚úÖ M√ìDULOS B14, B15, B17 - COMPLETADOS

**Fecha:** Octubre 9, 2025  
**Archivos modificados:** `bACKEND/app.py`  
**Estado:** üü¢ Listo para probar

---

## üìã RESUMEN EJECUTIVO

Implementados **3 m√≥dulos simples** en **una sola sesi√≥n**:

- **B14:** Tags (1 cambio - validaci√≥n de acceso a candidatos)
- **B15:** Templates (1 cambio - BUG cr√≠tico corregido)
- **B17:** Calendar (2 cambios - filtros por usuario)

**Total:** 4 cambios, 2 bugs cr√≠ticos corregidos

---

## üîß M√ìDULO B14: TAGS

### **Cambios realizados:**

#### **1. GET/POST/DELETE `/api/candidate/<id>/tags`** (l√≠neas 3329-3377)

**Cambio:** ‚úÖ Agregada validaci√≥n de acceso al candidato

**Antes:**
```python
# Solo verificaba que el candidato pertenece al tenant
cursor.execute("SELECT id_afiliado FROM Afiliados WHERE id_afiliado = %s AND tenant_id = %s", (id_afiliado, tenant_id))
if not cursor.fetchone():
    return jsonify({"error": "Candidato no encontrado"}), 404

# ‚ùå NO verificaba si el usuario tiene acceso al candidato
```

**Despu√©s:**
```python
# Verifica tenant
cursor.execute("SELECT id_afiliado FROM Afiliados WHERE id_afiliado = %s AND tenant_id = %s", (id_afiliado, tenant_id))
if not cursor.fetchone():
    return jsonify({"error": "Candidato no encontrado"}), 404

# üîê M√ìDULO B14: Verificar acceso seg√∫n m√©todo
if request.method == 'GET':
    if not can_access_resource(user_id, tenant_id, 'candidate', id_afiliado, 'read'):
        return jsonify({'error': 'No tienes acceso a este candidato'}), 403
else:  # POST o DELETE requieren permiso de escritura
    if not can_access_resource(user_id, tenant_id, 'candidate', id_afiliado, 'write'):
        return jsonify({'error': 'No tienes acceso para modificar este candidato'}), 403
```

**Resultado esperado:**
| Usuario | Candidato | GET tags | POST tag | DELETE tag |
|---------|-----------|----------|----------|------------|
| **Admin** | Cualquiera | ‚úÖ | ‚úÖ | ‚úÖ |
| **Supervisor** | De su equipo | ‚úÖ | ‚úÖ | ‚úÖ |
| **Supervisor** | Ajeno | ‚ùå 403 | ‚ùå 403 | ‚ùå 403 |
| **Reclutador** | Propio | ‚úÖ | ‚úÖ | ‚úÖ |
| **Reclutador** | Ajeno | ‚ùå 403 | ‚ùå 403 | ‚ùå 403 |

---

## üîß M√ìDULO B15: TEMPLATES

### **Cambios realizados:**

#### **1. PUT `/api/templates/<id>`** (l√≠nea 3427) üö®

**Cambio:** ‚úÖ Corregido BUG cr√≠tico en UPDATE

**Antes (BUG CR√çTICO):**
```python
sql = "UPDATE Email_Templates SET nombre_plantilla=%s, asunto=%s, cuerpo_html=%s WHERE id_template=%s AND id_cliente=%s"
                                                                                                           ^^^^^^^^^^
# ‚ùå Columna "id_cliente" NO EXISTE en Email_Templates
# ‚ùå UPDATE siempre fallaba silenciosamente
```

**Despu√©s:**
```python
# üîê M√ìDULO B15: Corregido - usar tenant_id en lugar de id_cliente
sql = "UPDATE Email_Templates SET nombre_plantilla=%s, asunto=%s, cuerpo_html=%s WHERE id_template=%s AND tenant_id=%s"
                                                                                                           ^^^^^^^^^^
# ‚úÖ Columna correcta
```

**Impacto del BUG:**
- ‚ùå **ANTES:** UPDATE de templates NUNCA funcionaba
- ‚úÖ **DESPU√âS:** UPDATE funciona correctamente

---

## üîß M√ìDULO B17: CALENDAR

### **Cambios realizados:**

#### **1. GET `/api/calendar/interviews`** (l√≠neas 8697-8761)

**Cambio:** ‚úÖ Agregado filtro por usuario

**Antes:**
```python
cursor.execute("""
    SELECT ... FROM interviews i
    LEFT JOIN Vacantes v ON i.vacancy_id = v.id_vacante
    WHERE i.tenant_id = %s 
    AND YEAR(i.interview_date) = %s 
    AND MONTH(i.interview_date) = %s
""", (tenant_id, year, month))
# ‚ùå Todos ven TODAS las entrevistas del tenant
```

**Despu√©s:**
```python
vacancy_condition, vacancy_params = build_user_filter_condition(user_id, tenant_id, 'v.created_by_user')

sql = """
    SELECT ... FROM interviews i
    LEFT JOIN Vacantes v ON i.vacancy_id = v.id_vacante
    WHERE i.tenant_id = %s AND v.tenant_id = %s
    AND YEAR(i.interview_date) = %s 
    AND MONTH(i.interview_date) = %s
"""
if vacancy_condition:
    sql += f" AND ({vacancy_condition} OR v.created_by_user IS NULL)"

# ‚úÖ Filtrado por usuario seg√∫n rol
```

**Resultado esperado:**
| Usuario | Entrevistas en calendario |
|---------|--------------------------|
| **Admin** | TODAS del tenant |
| **Supervisor** | De su equipo + propias |
| **Reclutador** | Solo propias |

---

#### **2. GET `/api/calendar/activities`** (l√≠neas 8768-8850) üö®

**Cambio:** ‚úÖ Corregido BUG cr√≠tico + agregado filtro por usuario

**Antes (BUG CR√çTICO):**
```python
# Query 1: Postulaciones
SELECT ... FROM Postulaciones p
LEFT JOIN Vacantes v ON p.id_vacante = v.id_vacante
WHERE YEAR(p.fecha_aplicacion) = %s 
AND MONTH(p.fecha_aplicacion) = %s
# ‚ùå Sin filtro por tenant_id

UNION ALL

# Query 2: Interviews
SELECT ... FROM interviews i
WHERE i.tenant_id = %s ...
# ‚úÖ Con filtro por tenant_id
```

**Impacto del BUG:**
- ‚ùå **ANTES:** Postulaciones de TODOS los tenants mezcladas
- ‚úÖ **DESPU√âS:** Postulaciones filtradas por tenant y usuario

**Despu√©s:**
```python
vacancy_condition, vacancy_params = build_user_filter_condition(user_id, tenant_id, 'v.created_by_user')

# Query 1: Postulaciones con filtro
sql_postulaciones = """
    SELECT ... FROM Postulaciones p
    LEFT JOIN Vacantes v ON p.id_vacante = v.id_vacante
    WHERE v.tenant_id = %s
    AND YEAR(p.fecha_aplicacion) = %s 
    AND MONTH(p.fecha_aplicacion) = %s
"""
if vacancy_condition:
    sql_postulaciones += f" AND ({vacancy_condition} OR v.created_by_user IS NULL)"

# Query 2: Interviews con filtro
sql_interviews = """
    SELECT ... FROM interviews i
    LEFT JOIN Vacantes v ON i.vacancy_id = v.id_vacante
    WHERE i.tenant_id = %s AND v.tenant_id = %s
    AND YEAR(i.created_at) = %s 
    AND MONTH(i.created_at) = %s
"""
if vacancy_condition:
    sql_interviews += f" AND ({vacancy_condition} OR v.created_by_user IS NULL)"

# Combinar con UNION ALL
sql_combined = f"{sql_postulaciones} UNION ALL {sql_interviews} ORDER BY timestamp DESC"
```

**Resultado esperado:**
| Usuario | Actividades en calendario |
|---------|--------------------------|
| **Admin** | TODAS del tenant |
| **Supervisor** | De su equipo + propias |
| **Reclutador** | Solo propias |

---

## üêõ BUGS CR√çTICOS CORREGIDOS

### **Bug 1: UPDATE de Templates usaba columna incorrecta** üö®
**M√≥dulo:** B15  
**Gravedad:** ALTA

**Antes:**
```sql
UPDATE Email_Templates 
SET ... 
WHERE id_template = %s AND id_cliente = %s
                           ^^^^^^^^^^
-- ‚ùå Columna no existe en Email_Templates
-- UPDATE siempre retornaba 0 rows affected
```

**Despu√©s:**
```sql
UPDATE Email_Templates 
SET ... 
WHERE id_template = %s AND tenant_id = %s
-- ‚úÖ Columna correcta
```

---

### **Bug 2: Calendar Activities sin filtro de tenant en Postulaciones** üö®
**M√≥dulo:** B17  
**Gravedad:** CR√çTICA

**Antes:**
```sql
SELECT ... FROM Postulaciones p
WHERE YEAR(p.fecha_aplicacion) = %s
-- ‚ùå Sin filtro por tenant
-- Mostraba postulaciones de TODOS los tenants
```

**Despu√©s:**
```sql
SELECT ... FROM Postulaciones p
LEFT JOIN Vacantes v ON p.id_vacante = v.id_vacante
WHERE v.tenant_id = %s 
AND YEAR(p.fecha_aplicacion) = %s
-- ‚úÖ Con filtro por tenant y usuario
```

---

## üß™ CASOS DE PRUEBA

### **Test 1: Tags - Reclutador intenta ver tags de candidato ajeno**

**Usuario:** Reclutador ID 8  
**Candidato:** ID 50 (created_by_user: 10)

**Request:**
```http
GET /api/candidate/50/tags
Authorization: Bearer <token_reclutador_8>
```

**Resultado esperado:**
```json
{
  "error": "No tienes acceso a este candidato"
}
```
**C√≥digo HTTP:** `403 Forbidden`

---

### **Test 2: Templates - UPDATE ahora funciona**

**Usuario:** Admin ID 1

**Request:**
```http
PUT /api/templates/5
Authorization: Bearer <token_admin_1>
Content-Type: application/json

{
  "nombre_plantilla": "Bienvenida actualizada",
  "asunto": "¬°Hola y bienvenido!",
  "cuerpo_html": "<h1>Bienvenido</h1>"
}
```

**Antes:**
- Query ejecutado: `WHERE id_template = 5 AND id_cliente = 1` (FALLA)
- Resultado: `{"error": "Plantilla no encontrada"}`

**Despu√©s:**
- Query ejecutado: `WHERE id_template = 5 AND tenant_id = 1` (√âXITO)
- Resultado: `{"success": true, "message": "Plantilla actualizada."}`

---

### **Test 3: Calendar Interviews - Supervisor ve solo su equipo**

**Usuario:** Supervisor ID 5 (equipo: [8, 12])  
**Entrevistas del mes:**
- 10 entrevistas (3 propias, 4 de ID 8, 2 de ID 12, 1 de ID 10)

**Request:**
```http
GET /api/calendar/interviews?year=2025&month=10
Authorization: Bearer <token_supervisor_5>
```

**Resultado esperado:**
```json
{
  "success": true,
  "data": [
    // ‚úÖ Solo 9 entrevistas (3 + 4 + 2)
    // ‚ùå No incluye la entrevista de ID 10
  ]
}
```

---

### **Test 4: Calendar Activities - Bug corregido**

**Usuario:** Admin ID 1 (Tenant 1)  
**Mes:** Octubre 2025

**Datos en BD:**
- Tenant 1: 15 postulaciones
- Tenant 2: 20 postulaciones
- Tenant 3: 10 postulaciones

**Request:**
```http
GET /api/calendar/activities?year=2025&month=10
Authorization: Bearer <token_admin_tenant_1>
```

**Antes (BUG):**
```json
{
  "success": true,
  "data": [
    // ‚ùå 45 actividades (15 + 20 + 10 de TODOS los tenants)
  ]
}
```

**Despu√©s (CORREGIDO):**
```json
{
  "success": true,
  "data": [
    // ‚úÖ Solo 15 actividades (del tenant 1)
  ]
}
```

---

## ‚úÖ CHECKLIST DE VALIDACI√ìN

### **Funcionalidad:**
- [x] B14: Tags valida acceso al candidato
- [x] B15: UPDATE de templates funciona correctamente
- [x] B17: Calendar interviews filtra por usuario
- [x] B17: Calendar activities filtra por tenant y usuario

### **Seguridad:**
- [x] Reclutador NO puede ver/modificar tags de candidatos ajenos
- [x] Supervisor puede gestionar tags de su equipo
- [x] Admin puede gestionar todos los tags
- [x] Calendar muestra solo entrevistas/actividades seg√∫n rol

### **Correcciones cr√≠ticas:**
- [x] **BUG CR√çTICO:** Corregido UPDATE de templates (id_cliente ‚Üí tenant_id)
- [x] **BUG CR√çTICO:** Agregado filtro de tenant en calendar activities (Postulaciones)
- [x] Agregado filtro de usuario en calendar interviews
- [x] Agregado validaci√≥n de acceso en tags de candidatos

---

## üìà PROGRESO TOTAL

```
BACKEND: 16/17 m√≥dulos (94.1%)

‚úÖ B1-B15, B17   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë  16/17 m√≥dulos

Completados:
‚úÖ B1  - Tablas Base
‚úÖ B2  - Columnas Trazabilidad
‚úÖ B4  - Permission Service
‚úÖ B5  - Candidatos
‚úÖ B6  - Vacantes
‚úÖ B7  - Postulaciones
‚úÖ B8  - Entrevistas
‚úÖ B9  - Clientes
‚úÖ B10 - Contratados
‚úÖ B11 - Dashboard
‚úÖ B12 - Reportes KPI
‚úÖ B13 - Notificaciones
‚úÖ B14 - Tags         ‚Üê NUEVO
‚úÖ B15 - Templates    ‚Üê NUEVO
‚úÖ B17 - Calendar     ‚Üê NUEVO

Pendiente:
‚¨ú B16 - Gesti√≥n de Equipos (2-3h) ‚Üê IMPORTANTE
```

---

## üöÄ SIGUIENTE PASO: M√ìDULO B16

**B16: Gesti√≥n de Equipos** es el √öLTIMO m√≥dulo de backend.

### **¬øQu√© incluye B16?**
- Endpoints para gestionar supervisores y sus equipos
- Asignar/remover miembros de equipo
- Listar miembros de equipo
- Gestionar `Team_Structure`

**Complejidad:** ALTA (es el n√∫cleo del sistema de jerarqu√≠as)  
**Tiempo estimado:** 2-3 horas

---

## üí° RECOMENDACI√ìN

### **Opci√≥n 1:** üöÄ **Implementar B16 ahora** (completar backend 100%)
- Tiempo: 2-3 horas
- Beneficio: Backend completamente terminado
- **Recomendado si:** Quieres terminar todo el backend de una vez

### **Opci√≥n 2:** üß™ **Probar B1-B17 (excepto B16)** antes de continuar
- Tiempo: 1-2 horas
- Beneficio: Validar TODO lo implementado
- **Recomendado si:** Quieres asegurar que todo funciona antes de continuar

### **Opci√≥n 3:** üì§ **Subir cambios al servidor y desplegar**
- Tiempo: 30-60 min
- Beneficio: Tener el 94% del backend en producci√≥n
- **Recomendado si:** Necesitas tener algo funcional YA

---

**¬øContinuamos con B16 o prefieres probar/desplegar primero?** üéØ

